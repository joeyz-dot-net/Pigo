<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA æµ‹è¯• - ClubMusic</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/images/favicon.ico" />
    <link rel="shortcut icon" href="/static/images/favicon.ico" />
    
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#667eea" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .status-label {
            font-weight: 500;
        }
        
        .status-value {
            font-family: 'Courier New', monospace;
            padding: 4px 12px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .status-ok {
            color: #4ade80;
        }
        
        .status-error {
            color: #f87171;
        }
        
        .status-warning {
            color: #fbbf24;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: rgba(102, 126, 234, 0.8);
            border-color: rgba(102, 126, 234, 1);
        }
        
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .info-box {
            background: rgba(59, 130, 246, 0.2);
            border-left: 4px solid #3b82f6;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .code-block {
            background: rgba(0, 0, 0, 0.4);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5em;
            }
            
            .status-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ PWA æµ‹è¯•é¡µé¢</h1>
        <p class="subtitle">ClubMusic - Progressive Web App åŠŸèƒ½æ£€æµ‹</p>
        
        <!-- Service Worker çŠ¶æ€ -->
        <div class="test-section">
            <h2>ğŸ“¡ Service Worker çŠ¶æ€</h2>
            <div class="status-item">
                <span class="status-label">æµè§ˆå™¨æ”¯æŒ</span>
                <span class="status-value" id="sw-support">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ³¨å†ŒçŠ¶æ€</span>
                <span class="status-value" id="sw-registered">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ¿€æ´»çŠ¶æ€</span>
                <span class="status-value" id="sw-active">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">æ§åˆ¶å™¨</span>
                <span class="status-value" id="sw-controller">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">è„šæœ¬URL</span>
                <span class="status-value" id="sw-url" style="font-size: 0.85em;">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
        
        <!-- Manifest çŠ¶æ€ -->
        <div class="test-section">
            <h2>ğŸ“„ Manifest çŠ¶æ€</h2>
            <div class="status-item">
                <span class="status-label">Manifest é“¾æ¥</span>
                <span class="status-value" id="manifest-link">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">åº”ç”¨åç§°</span>
                <span class="status-value" id="manifest-name">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å¯åŠ¨ URL</span>
                <span class="status-value" id="manifest-start-url">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
        
        <!-- å®‰è£…çŠ¶æ€ -->
        <div class="test-section">
            <h2>ğŸ“± å®‰è£…çŠ¶æ€</h2>
            <div class="status-item">
                <span class="status-label">æ˜¾ç¤ºæ¨¡å¼</span>
                <span class="status-value" id="display-mode">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç‹¬ç«‹æ¨¡å¼</span>
                <span class="status-value" id="standalone">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">å¯å®‰è£…</span>
                <span class="status-value" id="installable">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
        
        <!-- Cache API -->
        <div class="test-section">
            <h2>ğŸ’¾ Cache API</h2>
            <div class="status-item">
                <span class="status-label">Cache æ”¯æŒ</span>
                <span class="status-value" id="cache-support">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç¼“å­˜æ•°é‡</span>
                <span class="status-value" id="cache-count">æ£€æµ‹ä¸­...</span>
            </div>
            <div class="status-item">
                <span class="status-label">ç¼“å­˜é¡¹ç›®</span>
                <span class="status-value" id="cache-items">æ£€æµ‹ä¸­...</span>
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="test-section">
            <h2>ğŸ›  æ“ä½œ</h2>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="refreshStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                <button class="btn" onclick="clearAllCaches()">ğŸ—‘ æ¸…é™¤ç¼“å­˜</button>
                <button class="btn" onclick="unregisterSW()">âŒ æ³¨é”€ SW</button>
                <a href="/" class="btn">ğŸ  è¿”å›é¦–é¡µ</a>
            </div>
        </div>
        
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="info-box">
            <strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong>
            <ul style="margin-top: 10px; padding-left: 20px;">
                <li>âœ… çŠ¶æ€ä¸ºç»¿è‰²è¡¨ç¤ºæ­£å¸¸å·¥ä½œ</li>
                <li>âŒ çŠ¶æ€ä¸ºçº¢è‰²è¡¨ç¤ºæœªå¯ç”¨æˆ–å‡ºé”™</li>
                <li>âš ï¸ çŠ¶æ€ä¸ºé»„è‰²è¡¨ç¤ºéƒ¨åˆ†æ”¯æŒ</li>
                <li>å¦‚éœ€é‡æ–°æµ‹è¯•ï¼Œè¯·ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"æŒ‰é’®</li>
                <li>å¦‚é‡é—®é¢˜ï¼Œå¯å°è¯•"æ¸…é™¤ç¼“å­˜"åé‡æ–°åŠ è½½</li>
            </ul>
        </div>
    </div>
    
    <script>
        // PWA çŠ¶æ€æ£€æµ‹è„šæœ¬
        let installPromptEvent = null;
        
        // ç›‘å¬å®‰è£…æç¤º
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            installPromptEvent = e;
            console.log('[PWA] æ£€æµ‹åˆ°å®‰è£…æç¤ºäº‹ä»¶');
            updateInstallableStatus(true);
        });
        
        // ç›‘å¬å·²å®‰è£…
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] åº”ç”¨å·²å®‰è£…åˆ°ä¸»å±å¹•');
            installPromptEvent = null;
        });
        
        // æ£€æµ‹ Service Worker çŠ¶æ€
        async function checkServiceWorker() {
            const supportEl = document.getElementById('sw-support');
            const registeredEl = document.getElementById('sw-registered');
            const activeEl = document.getElementById('sw-active');
            const controllerEl = document.getElementById('sw-controller');
            const urlEl = document.getElementById('sw-url');
            
            if ('serviceWorker' in navigator) {
                supportEl.textContent = 'âœ… æ”¯æŒ';
                supportEl.className = 'status-value status-ok';
                
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    
                    if (registration) {
                        registeredEl.textContent = 'âœ… å·²æ³¨å†Œ';
                        registeredEl.className = 'status-value status-ok';
                        
                        if (registration.active) {
                            activeEl.textContent = 'âœ… å·²æ¿€æ´»';
                            activeEl.className = 'status-value status-ok';
                            urlEl.textContent = registration.active.scriptURL;
                            urlEl.className = 'status-value status-ok';
                        } else if (registration.installing) {
                            activeEl.textContent = 'â³ å®‰è£…ä¸­';
                            activeEl.className = 'status-value status-warning';
                        } else if (registration.waiting) {
                            activeEl.textContent = 'â¸ ç­‰å¾…æ¿€æ´»';
                            activeEl.className = 'status-value status-warning';
                        } else {
                            activeEl.textContent = 'âŒ æœªæ¿€æ´»';
                            activeEl.className = 'status-value status-error';
                        }
                    } else {
                        registeredEl.textContent = 'âŒ æœªæ³¨å†Œ';
                        registeredEl.className = 'status-value status-error';
                        activeEl.textContent = 'âŒ æœªæ¿€æ´»';
                        activeEl.className = 'status-value status-error';
                        urlEl.textContent = 'N/A';
                        urlEl.className = 'status-value';
                    }
                    
                    if (navigator.serviceWorker.controller) {
                        controllerEl.textContent = 'âœ… å·²æ§åˆ¶';
                        controllerEl.className = 'status-value status-ok';
                    } else {
                        controllerEl.textContent = 'âŒ æœªæ§åˆ¶';
                        controllerEl.className = 'status-value status-error';
                    }
                } catch (err) {
                    console.error('[PWA] æ£€æµ‹ Service Worker å¤±è´¥:', err);
                    registeredEl.textContent = 'âŒ æ£€æµ‹å¤±è´¥';
                    registeredEl.className = 'status-value status-error';
                }
            } else {
                supportEl.textContent = 'âŒ ä¸æ”¯æŒ';
                supportEl.className = 'status-value status-error';
                registeredEl.textContent = 'N/A';
                activeEl.textContent = 'N/A';
                controllerEl.textContent = 'N/A';
                urlEl.textContent = 'N/A';
            }
        }
        
        // æ£€æµ‹ Manifest
        async function checkManifest() {
            const linkEl = document.getElementById('manifest-link');
            const nameEl = document.getElementById('manifest-name');
            const startUrlEl = document.getElementById('manifest-start-url');
            
            const manifestLink = document.querySelector('link[rel="manifest"]');
            
            if (manifestLink) {
                linkEl.textContent = 'âœ… å·²é“¾æ¥';
                linkEl.className = 'status-value status-ok';
                
                try {
                    const response = await fetch(manifestLink.href);
                    const manifest = await response.json();
                    
                    nameEl.textContent = manifest.name || manifest.short_name || 'N/A';
                    nameEl.className = 'status-value status-ok';
                    
                    startUrlEl.textContent = manifest.start_url || '/';
                    startUrlEl.className = 'status-value status-ok';
                } catch (err) {
                    console.error('[PWA] è§£æ Manifest å¤±è´¥:', err);
                    nameEl.textContent = 'âŒ è§£æå¤±è´¥';
                    nameEl.className = 'status-value status-error';
                    startUrlEl.textContent = 'âŒ è§£æå¤±è´¥';
                    startUrlEl.className = 'status-value status-error';
                }
            } else {
                linkEl.textContent = 'âŒ æœªæ‰¾åˆ°';
                linkEl.className = 'status-value status-error';
                nameEl.textContent = 'N/A';
                startUrlEl.textContent = 'N/A';
            }
        }
        
        // æ£€æµ‹å®‰è£…çŠ¶æ€
        function checkInstallStatus() {
            const displayModeEl = document.getElementById('display-mode');
            const standaloneEl = document.getElementById('standalone');
            
            const displayMode = window.matchMedia('(display-mode: standalone)').matches ? 'standalone' :
                               window.matchMedia('(display-mode: fullscreen)').matches ? 'fullscreen' :
                               window.matchMedia('(display-mode: minimal-ui)').matches ? 'minimal-ui' : 'browser';
            
            displayModeEl.textContent = displayMode;
            displayModeEl.className = displayMode === 'standalone' ? 'status-value status-ok' : 'status-value';
            
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true;
            
            standaloneEl.textContent = isStandalone ? 'âœ… æ˜¯' : 'âŒ å¦';
            standaloneEl.className = isStandalone ? 'status-value status-ok' : 'status-value';
        }
        
        // æ›´æ–°å¯å®‰è£…çŠ¶æ€
        function updateInstallableStatus(installable) {
            const installableEl = document.getElementById('installable');
            
            // iOS Safari ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœå·²ç»åœ¨standaloneæ¨¡å¼ï¼Œè¯´æ˜å·²å®‰è£…
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                window.navigator.standalone === true;
            
            if (isStandalone) {
                // å·²ç»ä»ä¸»å±å¹•å¯åŠ¨ï¼Œè¯´æ˜å·²å®‰è£…
                installableEl.textContent = 'âœ… å·²å®‰è£…ï¼ˆä»ä¸»å±å¹•å¯åŠ¨ï¼‰';
                installableEl.className = 'status-value status-ok';
            } else if (installable) {
                // å¯ä»¥å®‰è£…
                installableEl.textContent = 'âœ… å¯å®‰è£…';
                installableEl.className = 'status-value status-ok';
            } else {
                // iOS Safari é€šè¿‡"æ·»åŠ åˆ°ä¸»å±å¹•"å®‰è£…ï¼Œä¸æ”¯æŒæ ‡å‡†å®‰è£…æç¤º
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) {
                    installableEl.textContent = 'âš ï¸ ä½¿ç”¨Safari"æ·»åŠ åˆ°ä¸»å±å¹•"';
                    installableEl.className = 'status-value status-warning';
                } else {
                    installableEl.textContent = 'âŒ ä¸å¯å®‰è£…';
                    installableEl.className = 'status-value status-error';
                }
            }
        }
        
        // æ£€æµ‹ Cache API
        async function checkCacheAPI() {
            const supportEl = document.getElementById('cache-support');
            const countEl = document.getElementById('cache-count');
            const itemsEl = document.getElementById('cache-items');
            
            if ('caches' in window) {
                supportEl.textContent = 'âœ… æ”¯æŒ';
                supportEl.className = 'status-value status-ok';
                
                try {
                    const cacheNames = await caches.keys();
                    countEl.textContent = cacheNames.length;
                    countEl.className = 'status-value status-ok';
                    
                    let totalItems = 0;
                    for (const name of cacheNames) {
                        const cache = await caches.open(name);
                        const keys = await cache.keys();
                        totalItems += keys.length;
                    }
                    
                    itemsEl.textContent = totalItems;
                    itemsEl.className = 'status-value status-ok';
                } catch (err) {
                    console.error('[PWA] æ£€æµ‹ç¼“å­˜å¤±è´¥:', err);
                    countEl.textContent = 'âŒ æ£€æµ‹å¤±è´¥';
                    countEl.className = 'status-value status-error';
                    itemsEl.textContent = 'âŒ æ£€æµ‹å¤±è´¥';
                    itemsEl.className = 'status-value status-error';
                }
            } else {
                supportEl.textContent = 'âŒ ä¸æ”¯æŒ';
                supportEl.className = 'status-value status-error';
                countEl.textContent = 'N/A';
                itemsEl.textContent = 'N/A';
            }
        }
        
        // åˆ·æ–°æ‰€æœ‰çŠ¶æ€
        async function refreshStatus() {
            console.log('[PWA] åˆ·æ–°çŠ¶æ€...');
            await checkServiceWorker();
            await checkManifest();
            checkInstallStatus();
            await checkCacheAPI();
            
            // æ£€æŸ¥æ˜¯å¦å¯å®‰è£…
            if (!installPromptEvent) {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                                    window.navigator.standalone === true;
                updateInstallableStatus(!isStandalone && 'beforeinstallprompt' in window);
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
        async function clearAllCaches() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å—ï¼Ÿ')) return;
            
            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                alert('âœ… å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼');
                await refreshStatus();
            } catch (err) {
                console.error('[PWA] æ¸…é™¤ç¼“å­˜å¤±è´¥:', err);
                alert('âŒ æ¸…é™¤ç¼“å­˜å¤±è´¥: ' + err.message);
            }
        }
        
        // æ³¨é”€ Service Worker
        async function unregisterSW() {
            if (!confirm('ç¡®å®šè¦æ³¨é”€ Service Worker å—ï¼Ÿ')) return;
            
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    await registration.unregister();
                    alert('âœ… Service Worker å·²æ³¨é”€ï¼');
                    await refreshStatus();
                } else {
                    alert('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å·²æ³¨å†Œçš„ Service Worker');
                }
            } catch (err) {
                console.error('[PWA] æ³¨é”€å¤±è´¥:', err);
                alert('âŒ æ³¨é”€å¤±è´¥: ' + err.message);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œæ£€æµ‹
        window.addEventListener('load', () => {
            refreshStatus();
        });
    </script>
</body>
</html>
