# ClubMusic 说明文档（2025-12-28 更新）

## 主要功能

- **全栈网页音乐播放器**，支持本地与网络（YouTube）歌曲播放
- **多歌单管理**，用户隔离（每个浏览器独立队列）
- **自动播放/自动下一曲**：完全由后端 MPV 事件监听控制
- **支持随机填充队列**：当默认歌单为空时，支持一键随机添加10首歌（来自所有歌单和本地音乐）
- **多语言支持**（中英双语，自动检测/切换）
- **Windows 优化**，支持 PyInstaller 打包

---

## 关键架构与工作流

### 1. 用户隔离与歌单管理

- 当前歌单选择保存在浏览器 `localStorage.selectedPlaylistId`，每个浏览器/标签页互不影响
- 歌单数据由前端 `playlistManager` 管理，所有操作（添加/删除/切换）均通过 API 与后端同步
- 歌单修改后必须调用 `PLAYLISTS_MANAGER.save()`，否则数据不会持久化

### 2. 自动播放与队列管理

- **自动下一曲**：后端 MPV 事件监听 `end-file`，自动删除当前歌曲并播放下一首（见 `models/player.py`）
- 前端只负责 UI 状态展示，不主动控制自动播放
- 队列为空时，前端可显示“随机添加10首歌”按钮，用户可一键填充队列并自动播放

### 3. 随机添加10首歌到默认歌单

- 当默认歌单为空时，播放列表页面会显示“🎲 随机添加10首歌”按钮
- 点击后会从所有歌单和本地音乐中去重随机选取10首，批量添加到默认歌单并自动播放第一首
- 相关逻辑见 `static/js/playlist.js` 的 `renderPlaylistUI` 空队列分支

### 4. API 设计规范

- **播放器控制**（如 `/play`, `/seek`, `/volume`）：使用 `FormData`
- **歌单/数据 CRUD**（如 `/playlists`, `/playlist_add`）：使用 JSON
- **所有 API 路由必须前后端同步**，字段名、数据结构严格一致

### 5. 关键文件说明

| 文件 | 说明 |
|------|------|
| `main.py` | 启动器，音频设备选择，启动 FastAPI |
| `app.py` | FastAPI 主应用，所有 API 路由 |
| `models/player.py` | 播放器核心，MPV IPC、自动播放、事件监听 |
| `models/playlists.py` | 多歌单管理，持久化 |
| `models/song.py` | 歌曲数据结构，支持本地/YouTube |
| `static/js/main.js` | 前端主入口，UI/状态管理 |
| `static/js/playlist.js` | 歌单管理与渲染，随机添加逻辑 |
| `static/js/api.js` | 前端 API 封装，需与后端同步 |
| `static/js/i18n.js` | 多语言支持 |

---

## 典型使用场景

### 随机填充队列

1. 打开播放器，若“队列”为空，页面会显示“🎲 随机添加10首歌”按钮
2. 点击按钮后，系统会自动从所有歌单和本地音乐中随机选取10首，添加到默认歌单并自动播放
3. 若队列已存在歌曲，则不会自动填充

### 自动下一曲

- 每当一首歌播放结束，后端会自动删除已播放歌曲并播放下一首，无需前端干预
- 前端通过轮询 `/status` 自动感知当前播放状态并刷新 UI

---

## 常见问题

- **为什么自动下一曲有时不生效？**
  - 请确保后端 MPV 事件监听线程正常运行，且未被多实例覆盖
- **为什么添加歌曲后队列没有变化？**
  - 检查前后端 API 字段是否完全一致，确保调用 `PLAYLISTS_MANAGER.save()`
- **为什么不同浏览器队列不同？**
  - 这是设计特性，每个浏览器/标签页独立保存队列，互不影响

---

## 开发注意事项

- **新增/修改 API 路由时，务必同步更新前端 `api.js` 和后端 `app.py`**
- **所有歌单操作后必须调用 `save()` 方法**
- **多语言文本需同时添加 `zh` 和 `en` 键**
- **不要在前端实现自动下一曲逻辑，避免与后端冲突**

---

## 参考代码片段

### 随机添加10首歌按钮（前端）

```javascript
if (selectedPlaylistId === 'default') {
    const randomBtn = document.createElement('button');
    randomBtn.innerHTML = '🎲 随机添加10首歌';
    randomBtn.onclick = async () => {
        // ...见 playlist.js 详细实现...
    };
    emptyContainer.appendChild(randomBtn);
}
```

---

## 版本历史

- 2025-12-28：完善随机填充队列、自动下一曲、用户隔离等说明
- 2025-12-27：补充多语言、API同步、后端事件监听等关键规则

---

如需详细开发规范，请参阅 `.github/copilot-instructions.md`。